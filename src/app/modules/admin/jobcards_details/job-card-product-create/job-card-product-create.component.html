<div class="absolute inset-0 flex min-w-0 flex-col overflow-auto">
  <!-- Header -->
  <div
    class="bg-default flex flex-0 flex-col dark:bg-transparent sm:flex-row sm:items-center sm:justify-between sm:px-6 sm:pt-3"
  >
    <div class="min-w-0 flex-1 mb-6 border-b">
      <div class="mt-2">
        <!-- Make this a flex container to align buttons + search field -->
        <div class="flex justify-between items-center mb-6 gap-3">
          <!-- Search Bar -->
          <div class="flex items-center gap-2">
            <button
              class="px-1 py-1 text-white rounded-xl transition-all bg-amber-400"
            >
              <div
                class="flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-100 text-indigo-800 dark:bg-indigo-600 dark:text-indigo-50"
              >
                <mat-icon
                  class="text-current text-2xl"
                  [svgIcon]="'mat_outline:directions_car_filled'"
                ></mat-icon>
              </div>
            </button>
          </div>
          <div class="flex w-full flex-1 items-center gap-2">
            <div class="relative w-full">
              <input
                [formControl]="searchInputControl"
                (keydown.enter)="loadJobWorks()"
                class="w-full p-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400"
                [placeholder]="'Enter Job ID'"
              />
              <div
                class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400"
              >
                <ng-container>
                  <mat-icon
                    class="text-current text-2xl"
                    [svgIcon]="'mat_outline:directions_car_filled'"
                  ></mat-icon>
                </ng-container>
              </div>
            </div>
          </div>
          <button
            *ngIf="jobEstimateTreatments.length > 0"
            class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-600 hover:to-blue-600 rounded-lg shadow text-white flex items-center transition-all duration-200"
            mat-button
            (click)="updateRecords(0)"
          >
            <span class="">Update</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- <div class="px-6 rounded-2xl" *ngIf="resentEsitamte?.length > 0">
      <h2 class="text-3xl font-extrabold text-indigo-700 tracking-tight ml-3">
        Estimates
      </h2>
  
      <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"
      >
        <div
          *ngFor="let estimate of resentEsitamte"
          (click)="selectEsitamte(estimate.id)"
          class="bg-white rounded-2xl p-5 border border-gray-200 shadow-md hover:shadow-xl transition-all duration-300 cursor-pointer group transform hover:-translate-y-1"
        >
          <div class="flex items-center justify-between mb-2">
            <div class="font-medium text-gray-500 text-xl">Estimate ID</div>
            <div
              class="text-sm text-white bg-indigo-600 rounded-full px-3 py-1 group-hover:bg-indigo-700 transition"
            >
              #{{ estimate.id }}
            </div>
          </div>
  
          <div class="text-lg font-semibold text-gray-800 mb-1">
            {{ estimate.licenseNo }}
          </div>
  
          <div class="text-sm text-gray-600">
            Owner:
            <span class="font-medium">{{ estimate.vehicleOwnerName }}</span>
          </div>
  
          <div
            class="mt-4 text-xs text-right text-indigo-400 group-hover:text-indigo-600 transition"
          >
            Click to view details →
          </div>
        </div>
      </div>
    </div> -->

  <!-- <div class="px-4 mb-3">
    <div class="flex flex-wrap gap-1 px-2">
      <div
        *ngFor="let jobs of allJobs"
        (click)="searchInputControl.setValue(jobs.id); loadJobWorks()"
        class="bg-amber-500 text-white text-base font-medium px-4 py-2 rounded-xl shadow-sm hover:bg-amber-600 hover:scale-105 transition-all duration-200 ease-in-out cursor-pointer"
      >
        {{ jobs.jobCardNumber }}
      </div>
    </div>
  </div> -->

  <div class="px-4 mb-3">
    <div class="flex flex-wrap gap-1 px-2">
      <div
        *ngFor="let jobs of allJobs"
        (click)="searchInputControl.setValue(jobs.id); loadJobWorks()"
        class="bg-amber-500 text-white text-base font-medium px-4 py-2 rounded-xl shadow-sm hover:bg-amber-600 hover:scale-105 transition-all duration-200 ease-in-out cursor-pointer"
      >
        <div class="flex flex-col gap-1 leading-tight">
          <span class="font-semibold"
            >#{{ jobs.jobCardNumber }} — {{ jobs.id }}</span
          >
          <!-- <span>{{ jobs.vehicleOwnerName }}</span> -->
          <span class="text-sm opacity-90 italic">
            {{ jobs.createdDate ? (jobs.createdDate | date: "medium") : "N/A" }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="px-6 w-full" *ngIf="jobEstimateTreatments.length > 0">
    <div class="p-4 bg-white rounded-lg">
      <div class="flex justify-between">
        <h2 class="text-2xl font-bold capitalize mb-4 text-indigo-600">
          Job Estimate Details For
          <span class="text-red-500">{{
            jobEstimateTreatments[0].vehicleLicenseNumber
          }}</span>
        </h2>

        <div class="flex flex-col gap-2 py-2 px-6">
          <fuse-alert
            [appearance]="'soft'"
            [dismissible]="true"
            [dismissed]="true"
            [name]="'alertBox5'"
            [type]="'success'"
          >
            Works Saved Successfully
          </fuse-alert>

          <fuse-alert
            [appearance]="'soft'"
            [dismissible]="true"
            [dismissed]="true"
            [name]="'alertBox6'"
            [type]="'warn'"
          >
            Deleted Successfully
          </fuse-alert>
        </div>
      </div>

      <div class="p-3">
        <mat-button-toggle-group
          class="flex flex-wrap gap-2 text-sm font-semibold"
          [(ngModel)]="selectedEstimateId"
          (ngModelChange)="filterWorks()"
        >
          <mat-button-toggle
            [value]="'ALL'"
            class="!bg-gray-200 !text-gray-800 hover:!bg-indigo-100 hover:!text-indigo-700 rounded-lg px-4 py-2"
          >
            All
          </mat-button-toggle>

          <mat-button-toggle
            *ngFor="let id of estimateNumbers"
            [value]="id"
            class="!bg-amber-100 !text-gray-800 hover:!bg-indigo-100 hover:!text-indigo-700 rounded-lg px-4 py-2"
          >
            Estimate #{{ id }}
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Inner scrollable container -->
      <div class="overflow-x-auto">
        <div
          class="flex flex-col gap-2 min-w-max text-sm text-gray-800 px-4 mb-10"
        >
          <!-- Headers -->
          <div class="flex gap-4 font-semibold text-gray-700">
            <!-- <div class="w-48">Job ID</div> -->
            <div class="w-56">Estimate ID</div>
            <div class="w-56">Work Name</div>
            <div class="w-56">Start Date</div>

            <!-- <div class="w-56">Ops Unit</div> -->
          </div>

          <!-- Inputs -->
          <div
            class="flex gap-4 h-full"
            *ngFor="
              let treatment of filteredJobEstimateTreatments;
              let i = index
            "
          >
            <input
              class="w-56 p-3 border border-gray-300 rounded-lg"
              [(ngModel)]="treatment.estimateID"
              type="text"
              disabled
            />

            <input
              class="w-56 p-3 border border-gray-300 rounded-lg"
              [(ngModel)]="treatment.remarks"
              type="text"
              disabled
            />

            <input
              class="w-56 p-3 border border-gray-300 rounded-lg"
              [(ngModel)]="treatment.startDate"
              type="text"
              disabled
            />

            <div class="w-56 flex flex-row gap-2">
              <!-- Show added workers as chips for this treatment -->
              <div
                class="flex flex-row gap-3"
                *ngIf="treatment.jobEstimateWorkLogs?.length"
              >
                <div
                  *ngFor="
                    let user of treatment.jobEstimateWorkLogs;
                    let wi = index
                  "
                  class="flex items-center justify-between px-3 py-2 bg-yellow-50 border border-yellow-200 rounded-md shadow-sm text-sm text-yellow-900 hover:shadow-md transition cursor-pointer w-auto min-w-[180px]"
                  (click)="editWorkLog(user, wi, treatment, i)"
                >
                  <div class="flex flex-col">
                    <span class="font-medium">{{
                      user.workedEmployeeName
                    }}</span>
                    <span class="text-xs text-yellow-600"
                      >{{ user.workedHours }} hrs</span
                    >
                  </div>
                  <button
                    class="ml-3 text-yellow-500 hover:text-red-600 transition"
                    (click)="onRemoveClick($event, treatment, user)"
                    type="button"
                    aria-label="Remove worker"
                  >
                    ✕
                  </button>
                </div>
              </div>

              <!-- Plus button to toggle input field -->
              <div class="flex items-center gap-2">
                <!-- Show "+" only if input is hidden -->
                <button
                  (click)="openUserWizard(treatment, i)"
                  class="bg-indigo-500 text-white px-2 py-1 rounded-md"
                  type="button"
                >
                  +
                </button>
              </div>

              <!-- Input field for name + time (shown only if selected treatment is active) -->
              <div
                *ngIf="showUserInputForEstimateId === treatment.id"
                class="flex flex-row gap-2"
              >
                <input
                  type="text"
                  class="w-26 p-3 border border-gray-300 rounded-lg"
                  placeholder="Name"
                  [(ngModel)]="_newUser"
                />
                <input
                  type="number"
                  class="w-26 p-3 border border-gray-300 rounded-lg"
                  placeholder="Time"
                  [(ngModel)]="_newTime"
                />
                <button
                  (click)="addAssignedUser(treatment, i)"
                  class="bg-green-500 text-white py-1 rounded-lg w-18"
                  type="button"
                >
                  Add
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Wizard Modal -->
<div
  *ngIf="showUserWizard"
  class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 px-4"
>
  <!-- Worker Wizard -->
  <div
    *ngIf="!showProductWizard"
    class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl space-y-5"
  >
    <h3 class="text-xl font-semibold text-indigo-700 border-b pb-2">
      Add Worker to Estimate #{{ activeEstimate?.id }}
    </h3>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
      <input
        type="text"
        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
        placeholder="Enter worker name"
        [(ngModel)]="_newUser"
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Hours</label>
      <input
        type="number"
        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
        placeholder="Enter hours"
        [(ngModel)]="_newTime"
      />
    </div>

    <!-- Product Chips -->
    <div *ngIf="tempProducts.length > 0" class="space-y-2">
      <h4 class="text-sm font-medium text-gray-600">Used Products</h4>
      <div class="flex flex-wrap gap-3">
        <div
          *ngFor="let prod of tempProducts; let pi = index"
          class="flex items-center justify-between px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm text-gray-800 min-w-[220px]"
        >
          <div class="flex flex-col">
            <span class="font-medium">{{ prod.workProductName }}</span>
            <span class="text-xs text-gray-500"
              >{{ prod.quantity }} {{ prod.unit }}</span
            >
          </div>
          <button
            class="ml-3 text-gray-400 hover:text-red-600 transition"
            (click)="removeTempProduct(pi)"
          >
            ✕
          </button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between pt-3 border-t">
      <button
        (click)="cancelEdit()"
        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition"
      >
        Cancel
      </button>
      <div class="flex gap-2">
        <button
          (click)="showProductWizard = true"
          class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
        >
          Add Product
        </button>
        <button
          (click)="addAssignedUser(activeEstimate, activeIndex)"
          class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"
        >
          Save Worker
        </button>
      </div>
    </div>
  </div>

  <!-- Product Wizard -->
  <div
    *ngIf="showProductWizard"
    class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl space-y-5"
  >
    <h3 class="text-xl font-semibold text-indigo-700 border-b pb-2">
      Add Product to Estimate #{{ activeEstimate?.id }}
    </h3>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1"
        >Product Name</label
      >
      <input
        type="text"
        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
        placeholder="Enter product name"
        [(ngModel)]="_newProduct"
      />
    </div>

    <div class="flex gap-3">
      <div class="w-1/2">
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Quantity</label
        >
        <input
          type="number"
          class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
          [(ngModel)]="_newProductQuantity"
        />
      </div>
      <div class="w-1/2">
        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
        <input
          type="text"
          class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
          [(ngModel)]="_newUnit"
        />
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
      <textarea
        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400"
        rows="2"
        [(ngModel)]="_newNote"
      ></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between pt-3 border-t">
      <button
        (click)="showProductWizard = false"
        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition"
      >
        Back
      </button>
      <button
        (click)="addProductToTempProducts(activeEstimate, activeIndex)"
        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition"
      >
        Add Product
      </button>
    </div>
  </div>
</div>
