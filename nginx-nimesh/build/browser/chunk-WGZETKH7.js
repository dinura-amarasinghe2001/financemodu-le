import{a as Q}from"./chunk-V44XL57R.js";import{a as h}from"./chunk-LYMDSWFK.js";import{a as G,b as K,c as q}from"./chunk-TEYA6QDP.js";import{b as H,o as V,s as X,u as y,y as Y}from"./chunk-MZLVPJ5Q.js";import{Bc as m,Db as F,Dc as $,G as E,K as U,Kb as W,P as M,Qc as B,S as j,Sc as J,Ta as L,_b as A,a as f,b as g,ba as b,ca as N,cc as T,da as P,dc as x,ea as u,ia as k,m as D,na as C,nb as I,oa as p,ob as S,oc as z,qc as O,t as d,u as R}from"./chunk-2GFQMTJ2.js";var ee=(()=>{class o{constructor(e,t){this.document=e,this.platformId=t,this.documentIsAccessible=X(this.platformId)}static getCookieRegExp(e){let t=e.replace(/([\[\]{}()|=;+?,.*^$])/gi,"\\$1");return new RegExp("(?:^"+t+"|;\\s*"+t+")=(.*?)(?:;|$)","g")}static safeDecodeURIComponent(e){try{return decodeURIComponent(e)}catch{return e}}check(e){return this.documentIsAccessible?(e=encodeURIComponent(e),o.getCookieRegExp(e).test(this.document.cookie)):!1}get(e){if(this.check(e)){e=encodeURIComponent(e);let i=o.getCookieRegExp(e).exec(this.document.cookie);return i&&i[1]?o.safeDecodeURIComponent(i[1]):""}else return""}getAll(){if(!this.documentIsAccessible)return{};let e={},t=this.document;return t.cookie&&t.cookie!==""&&t.cookie.split(";").forEach(i=>{let[n,r]=i.split("=");e[o.safeDecodeURIComponent(n.replace(/^ /,""))]=o.safeDecodeURIComponent(r)}),e}set(e,t,i,n,r,a,_,ie){if(!this.documentIsAccessible)return;if(typeof i=="number"||i instanceof Date||n||r||a||_){let w={expires:i,path:n,domain:r,secure:a,sameSite:_||"Lax",partitioned:ie};this.set(e,t,w);return}let l=encodeURIComponent(e)+"="+encodeURIComponent(t)+";",c=i||{};if(c.expires)if(typeof c.expires=="number"){let w=new Date(new Date().getTime()+c.expires*1e3*60*60*24);l+="expires="+w.toUTCString()+";"}else l+="expires="+c.expires.toUTCString()+";";c.path&&(l+="path="+c.path+";"),c.domain&&(l+="domain="+c.domain+";"),c.secure===!1&&c.sameSite==="None"&&(c.secure=!0,console.warn(`[ngx-cookie-service] Cookie ${e} was forced with secure flag because sameSite=None.More details : https://github.com/stevermeister/ngx-cookie-service/issues/86#issuecomment-597720130`)),c.secure&&(l+="secure;"),c.sameSite||(c.sameSite="Lax"),l+="sameSite="+c.sameSite+";",c.partitioned&&(l+="Partitioned;"),this.document.cookie=l}delete(e,t,i,n,r="Lax"){if(!this.documentIsAccessible)return;let a=new Date("Thu, 01 Jan 1970 00:00:01 GMT");this.set(e,"",{expires:a,path:t,domain:i,secure:n,sameSite:r})}deleteAll(e,t,i,n="Lax"){if(!this.documentIsAccessible)return;let r=this.getAll();for(let a in r)r.hasOwnProperty(a)&&this.delete(a,e,t,i,n)}static{this.\u0275fac=function(t){return new(t||o)(C(H),C(L))}}static{this.\u0275prov=k({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var v=class{static isTokenExpired(s,e){if(!s||s==="")return!0;let t=this._getTokenExpirationDate(s);return e=e||0,t===null?!0:!(t.valueOf()>new Date().valueOf()+e*1e3)}static _b64decode(s){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="";if(s=String(s).replace(/=+$/,""),s.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i=0,n,r,a=0;r=s.charAt(a++);~r&&(n=i%4?n*64+r:r,i++%4)?t+=String.fromCharCode(255&n>>(-2*i&6)):0)r=e.indexOf(r);return t}static _b64DecodeUnicode(s){return decodeURIComponent(Array.prototype.map.call(this._b64decode(s),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:{e+="==";break}case 3:{e+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(e)}static _decodeToken(s){if(!s)return null;let e=s.split(".");if(e.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let t=this._urlBase64Decode(e[1]);if(!t)throw new Error("Cannot decode the token.");return JSON.parse(t)}static _getTokenExpirationDate(s){let e=this._decodeToken(s);if(!e.hasOwnProperty("exp"))return null;let t=new Date(0);return t.setUTCSeconds(e.exp),t}};function oe(o,s){if(o&1&&(m(0),B(1,"i18nPlural")),o&2){let e=O();$(" Redirecting in ",J(1,1,e.countdown,e.countdownMapping)," ")}}function re(o,s){o&1&&m(0," You are now being redirected! ")}var te=(()=>{class o{constructor(e,t){this.dialogRef=e,this.data=t,this.countdown=5,this.countdownMapping={"=1":"# second",other:"# seconds"},this._unsubscribeAll=new D}ngOnInit(){E(1e3,1e3).pipe(j(()=>{this.confirm()}),P(()=>this.countdown>0),N(this._unsubscribeAll),u(()=>this.countdown--)).subscribe()}confirm(){this.dialogRef.close(!0)}cancel(){this.dialogRef.close(!1)}static{this.\u0275fac=function(t){return new(t||o)(S(G),S(K))}}static{this.\u0275cmp=F({type:o,selectors:[["active-confirmation-wizard"]],decls:9,vars:2,consts:[[1,"flex","flex-col","items-center","p-3","text-center"],[1,"text-xl","font-semibold","text-gray-800","dark:text-white"],[1,"mt-0.5","flex","justify-center","font-medium"],[1,"mt-6","flex","space-x-3"],["mat-button","",1,"rounded-lg","bg-red-500","px-4","py-2","text-2xl","text-white","shadow-lg","hover:bg-red-600","focus:outline-none","focus:ring","focus:ring-red-300",3,"click"]],template:function(t,i){t&1&&(T(0,"div",0)(1,"h2",1),m(2," Session expired due to inactivity. Please log in again. "),x(),T(3,"div",2),W(4,oe,2,4)(5,re,1,0),x(),T(6,"div",3)(7,"button",4),z("click",function(){return i.confirm()}),m(8," Ok "),x()()()),t&2&&(I(4),A(i.countdown>0?4:-1),I(),A(i.countdown===0?5:-1))},dependencies:[V],encapsulation:2})}}return o})();var Se=(()=>{class o{constructor(){this._authenticated=!1,this._httpClient=p(Y),this._userService=p(Q),this.cookieService=p(ee),this._dialogService=p(q)}set accessToken(e){localStorage.setItem("accessToken",e)}get accessToken(){return localStorage.getItem("accessToken")??""}set refreshToken(e){localStorage.setItem("refreshToken",e)}get refreshToken(){return localStorage.getItem("refreshToken")??""}set expireTime(e){localStorage.setItem("expireTime",e)}get expireTime(){return localStorage.getItem("expireTime")??""}forgotPassword(e){return this._httpClient.post("api/auth/forgot-password",e)}resetPassword(e){return this._httpClient.post("api/auth/reset-password",e)}signIn(e){if(this._authenticated)return R("User is already logged in.");let t=new y({"Content-Type":"application/x-www-form-urlencoded"}),i=new URLSearchParams;return i.set("grant_type","password"),i.set("client_id","macmi_nimeshMotors"),i.set("username",e.username),i.set("password",e.password),i.set("client_secret","enSW3YuTLFtCFfvvivMjh8toVC4XAy8J"),i.set("scope","openid offline_access"),this._httpClient.post(h.sso,i.toString(),{headers:t}).pipe(b(n=>{return console.log(n),this._authenticated=!0,this.accessToken=n.access_token,this.refreshToken=n.refresh_token,this.expireTime=n.expires_in,this._httpClient.get(`${h.apiBaseUrl}/api/account`,{headers:{Authorization:"Bearer "+this.accessToken}}).pipe(b(r=>(h.user=g(f({},r),{name:r.firstName+" "+r.lastName,avatar:"https://api.dicebear.com/9.x/shapes/svg?seed="+r.id}),this._userService.user=g(f({},r),{name:r.firstName+" "+r.lastName,avatar:"https://api.dicebear.com/9.x/shapes/svg?seed="+r.id}),this._authenticated=!0,this.startActivityMonitoring(),d(n))));return d(n)}))}startActivityMonitoring(){this.resetInactivityTimer()}resetInactivityTimer(){clearTimeout(this._inactivityTimer),this._inactivityTimer=setTimeout(()=>{this._authenticated&&this.refreshTokenIfActive()},1e4)}openActiveDialog(){this._dialogService.open(te,{width:"60vh",maxHeight:"90vh"}).afterClosed().subscribe(()=>{this.signOut(),location.reload()})}refreshTokenIfActive(){this.refreshAccessToken().subscribe({next:()=>console.log("[Token Refresh] Success"),error:()=>{console.error("[Token Refresh] Failed"),this.signOut(),location.reload()}})}refreshAccessToken(){let e=new y({"Content-Type":"application/x-www-form-urlencoded"}),t=new URLSearchParams;return t.set("grant_type","refresh_token"),t.set("client_id","macmi_nimeshMotors"),t.set("client_secret","enSW3YuTLFtCFfvvivMjh8toVC4XAy8J"),t.set("refresh_token",this.refreshToken),this._httpClient.post(h.sso,t.toString(),{headers:e}).pipe(u(i=>{this.accessToken=i.access_token,console.log("Access Token",this.accessToken),this.refreshToken=i.refresh_token,console.log("Refresh Token",this.refreshToken)}))}signOut(){this._authenticated=!1,localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),this.cookieService.deleteAll()}check(){return this.refreshToken?this._authenticated?d(!0):!this.accessToken||v.isTokenExpired(this.accessToken)?(this.signOut(),d(!1)):this._httpClient.get(`${h.apiBaseUrl}/api/account`).pipe(u(e=>{this._authenticated=!0;let t=g(f({},e),{name:`${e.firstName} ${e.lastName}`,avatar:`https://api.dicebear.com/9.x/shapes/svg?seed=${e.id}`});h.user=t,this._userService.user=t}),M(!0),U(()=>(this.signOut(),d(!1)))):d(!1)}handleLogout(){clearTimeout(this._refreshTokenTimer),this._authenticated=!1,this.accessToken=null,this.refreshToken=null,localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),this.cookieService.deleteAll(),this.cookieService.delete("XSRF-TOKEN"),this._authenticated=!1}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=k({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{ee as a,v as b,Se as c};
