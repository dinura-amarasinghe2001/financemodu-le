########################################
# API Server Block
########################################
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name api.nimeshmotors.lk;

    ssl_certificate /etc/nginx/ssl/cert.crt;
    ssl_certificate_key /etc/nginx/ssl/cert.key;
    ssl_session_timeout 1h;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:EECDH+AESGCM:EECDH+AES:RSA+AESGCM:RSA+AES:!aNULL:!eNULL:!MD5:!EXPORT:!PSK:!RC4';
    ssl_prefer_server_ciphers on;
    ssl_ecdh_curve secp384r1;
    ssl_stapling on;
    ssl_stapling_verify on;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    access_log /var/log/nginx/api.nimeshmotors.lk.access.log combined;
    error_log /var/log/nginx/api.nimeshmotors.lk.error.log error;

    location / {
        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Content-Length' 0;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            return 204;
        }

        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        proxy_pass http://88.223.92.162:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /health {
        access_log off;
        return 200 "OK";
    }
}


########################################
# Operations Server Block
########################################
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name operations.nimeshmotors.lk ops.nimeshmotors.lk sys.nimeshmotors.lk;

    ssl_certificate /etc/nginx/ssl/cert.crt;
    ssl_certificate_key /etc/nginx/ssl/cert.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_stapling on;
    ssl_stapling_verify on;

    access_log /var/log/nginx/operations.nimeshmotors.lk.access.log combined;
    error_log /var/log/nginx/operations.nimeshmotors.lk.error.log error;

    location /api{
    add_header 'Access-Control-Allow-Origin' '*' always; 
    proxy_set_header        Host $host;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme; 
    proxy_pass http://88.223.92.162:8080; 
  } 

  location /services { 
    add_header 'Access-Control-Allow-Origin' '*' always; 
    proxy_set_header        Host $host;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme; 
    proxy_pass http://88.223.92.162:8080; 
  }  

  location /management { 
    add_header 'Access-Control-Allow-Origin' '*' always; 
    proxy_set_header        Host $host;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme; 
    proxy_pass http://88.223.92.162:8080; 
  }

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-NginX-Proxy true;
        add_header 'Access-Control-Allow-Origin' 'https://operations.nimeshmotors.lk' always;
        proxy_pass http://88.223.92.162:5000;
    }
}



server {
    listen 80;
    server_name lms.iclp.lk;

    access_log /var/log/nginx/lms.iclp.lk.access.log combined;
    error_log /var/log/nginx/lms.iclp.lk.error.log error;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-NginX-Proxy true;

        add_header 'Access-Control-Allow-Origin' '*' always;

        proxy_pass http://88.223.92.162:9980;
    }
}


########################################
# SSO / Keycloak Server Block
########################################
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name sso.nimeshmotors.lk;

    ssl_certificate /etc/nginx/ssl/cert.crt;
    ssl_certificate_key /etc/nginx/ssl/cert.key;
    ssl_session_timeout 1h;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:EECDH+AESGCM:EECDH+AES:RSA+AESGCM:RSA+AES:!aNULL:!eNULL:!MD5:!EXPORT:!PSK:!RC4';
    ssl_prefer_server_ciphers on;
    ssl_ecdh_curve secp384r1;
    ssl_stapling on;
    ssl_stapling_verify on;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    access_log /var/log/nginx/sso.nimeshmotors.lk.access.log combined;
    error_log /var/log/nginx/sso.nimeshmotors.lk.error.log error;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-NginX-Proxy true;

        # REMOVE CORS HEADERS HERE
        # add_header 'Access-Control-Allow-Origin' ... (REMOVE)
        proxy_pass https://88.223.92.162:9443;
    }

    location /health {
        access_log off;
        return 200 "OK";
    }
}
